# Public Domain (-) 2011 The Togethr Authors.
# See the Togethr UNLICENSE file for details.

import json

from bolt.api import *

chrome_tmpl = """// Public Domain (-) 2011 The Togethr Authors.
// See the Togethr UNLICENSE file for details.

// N.b.: This file is autogenerated by `bolt build_chrome`.

package togethr

const chrome = `%s`"""

@task
def build_chrome():

    # read the assetgen manifest json
    sock = open('app/build/assets.json')
    assets = sock.read().strip()
    sock.close()

    # process the assets
    data = json.loads(assets)
    init = data.pop('init.js')
    assets = [str(data[k]) for k in sorted(data)]

    # render the template
    sock = open('chrome.tmpl')
    tmpl = chrome_tmpl % sock.read()
    sock.close()
    chrome = tmpl.strip() % dict(assets=assets, init=init)

    # write to file
    sock = open('app/togethr/chrome.go', 'w')
    sock.write(chrome)
    sock.close()
