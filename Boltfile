# Public Domain (-) 2011 The Togethr Authors.
# See the Togethr UNLICENSE file for details.

import json

from bolt.api import *

chrome_tmpl = """// Public Domain (-) 2011 The Togethr Authors.
// See the Togethr UNLICENSE file for details.

// N.b.: This file is autogenerated by `bolt build_chrome`.

package togethr

const chrome = `%s`

const testChrome = `%s`"""

@task
def build_chrome():

    # Read the assetgen manifest JSON.
    sock = open('app/build/assets.json')
    assets = sock.read().strip()
    sock.close()

    # Process the assets.
    manifest = json.loads(assets)
    init = manifest.pop('init.js')
    assets = {}
    data = dict(assets=assets, init=init)
    for k, v in manifest.items():
        data[k.replace('.', '_')] = str(v)
        if k.startswith('qunit') or k.startswith('test'):
            continue
        assets[str(k)] = str(v)

    # Render the template.
    sock1 = open('template/chrome.tmpl')
    sock2 = open('template/test.tmpl')
    tmpl = chrome_tmpl % (sock1.read(), sock2.read())
    sock1.close()
    sock2.close()
    chrome = tmpl.strip() % data

    # Write to the file.
    sock = open('app/togethr/chrome.go', 'w')
    sock.write(chrome)
    sock.close()
