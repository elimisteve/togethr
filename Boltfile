# Public Domain (-) 2011-2012 The Togethr Authors.
# See the Togethr UNLICENSE file for details.

import json

from bolt.api import *

chrome_tmpl = """// Public Domain (-) 2011-2012 The Togethr Authors.
// See the Togethr UNLICENSE file for details.

// DO NOT EDIT THIS FILE DIRECTLY. IT IS AUTOGENERATED BY BOLT.

package togethr

const chrome = `%s`

const testChrome = `%s`

var (
	chromeBytes     = []byte(chrome)
	testChromeBytes = []byte(testChrome)
)
"""

from os.path import join

def read_file(filename):
    f = open(filename, 'rb')
    data = f.read()
    f.close()
    return data.strip()

@task
def build():
    """build togethr"""

    # Read the assetgen manifest.
    manifest = json.loads(read_file('app/build/assets.json'))

    # Process the assets.
    assets = {}
    data = dict(
        assets=assets,
        init_css=read_file(join('app/build', manifest.pop('init.css'))),
        init_js=read_file(join('app/build', manifest.pop('init.js')))
        )
    for k, v in manifest.items():
        data[k.replace('.', '_')] = str(v)
        if k.startswith('qunit') or k.startswith('test') or k.endswith('/bg.png'):
            continue
        assets[str(k)] = str(v)

    # Render the template.
    template = chrome_tmpl % (read_file('template/chrome.tmpl'), read_file('template/test.tmpl'))
    chrome = template.strip() % data

    # Write to the file.
    f = open('app/togethr/chrome.go', 'w')
    f.write(chrome)
    f.close()

@task
def deploy():
    """deploy togethr to remote servers"""

    local('appcfg.py', 'update', 'app')
